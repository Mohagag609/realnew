<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الاستثمار العقاري</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS variables for consistent theming */
        :root {
            --primary-color: #005A9C;      /* Professional Blue */
            --secondary-color: #007BFF;    /* Brighter Blue for accents */
            --light-color: #F8F9FA;        /* Off-white page background */
            --dark-color: #343A40;         /* Dark gray text */
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --white-color: #FFFFFF;        /* White card background */
            --gray-color: #CED4DA;         /* Borders */
            --light-gray-color: #E9ECEF;   /* Table head / hover */
            --border-radius: 4px;          /* Sharper corners */
            --box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Flatter shadow */
        }

        /* General body and typography styles */
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            background-color: var(--light-color);
            color: var(--dark-color);
            font-size: 16px;
            line-height: 1.6;
        }

        h1, h2, h3 {
            margin-top: 0;
            line-height: 1.2;
        }

        a {
            color: var(--secondary-color);
            text-decoration: none;
        }

        * {
            box-sizing: border-box;
        }

        /* Header and Navigation */
        header {
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        header .header-actions button {
            background: var(--secondary-color);
            color: var(--white-color);
            border: none;
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.2s ease;
        }
        header .header-actions button:hover {
            opacity: 0.8;
        }
        header .header-actions button:disabled {
            background: var(--gray-color);
            cursor: not-allowed;
        }

        nav {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .nav-btn {
            background-color: transparent;
            color: var(--light-color);
            border: 1px solid var(--light-color);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover, .nav-btn.active {
            background-color: var(--secondary-color);
            color: var(--white-color);
            border-color: var(--secondary-color);
        }

        /* Main content area */
        main {
            padding: 2rem;
        }

        .page {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card layout for content blocks */
        .card {
            background-color: var(--white-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--light-gray-color);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray-color);
        }

        .page-header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        /* Form elements */
        .input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-color);
            background-color: var(--white-color);
            color: var(--dark-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }


        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .btn {
            display: inline-block;
            background: var(--primary-color);
            color: var(--white-color) !important; /* Important to override other text colors */
            border: 1px solid var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn.ok { background-color: var(--success-color); border-color: var(--success-color); }
        .btn.warn { background-color: var(--danger-color); border-color: var(--danger-color); }
        .btn.neutral { background-color: #6C757D; border-color: #6C757D; }
        .btn.outline {
            background-color: transparent;
            color: var(--primary-color) !important;
            border-color: var(--gray-color);
        }
        .btn.outline:hover {
            background-color: var(--primary-color);
            color: var(--white-color) !important;
            border-color: var(--primary-color);
        }

        .btn:disabled {
            background-color: var(--light-gray-color);
            border-color: var(--light-gray-color);
            color: var(--gray-color) !important;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Table styles */
        .table-container {
            overflow-x: auto;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th, .table td {
            padding: 0.75rem;
            text-align: right;
            border-bottom: 1px solid var(--gray-color);
            white-space: nowrap;
        }

        .table thead th {
            background-color: var(--light-gray-color);
            font-weight: bold;
            color: var(--dark-color);
        }

        .table tbody tr:nth-child(even) {
            background-color: var(--white-color);
        }

        .table tbody tr:hover {
            background-color: var(--light-gray-color);
        }

        .table .actions {
            display: flex;
            gap: 5px;
        }

        /* Installment status styles */
        .table tr.paid { background-color: #d4edda !important; }
        .table tr.overdue { background-color: #f8d7da !important; }
        .table tr.due-soon { background-color: #fff3cd !important; }


        /* Modal styles */
        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        #modal-container {
            background: var(--white-color);
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            border: 1px solid var(--gray-color);
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        #modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-color);
        }

        #modal-title {
            margin: 0;
            font-size: 1.5rem;
            color: var(--secondary-color);
        }

        #modal-close-btn {
            background: transparent;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--gray-color);
            padding: 0;
            line-height: 1;
        }
        #modal-close-btn:hover {
            color: var(--secondary-color);
        }

        #modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        #modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--light-gray-color);
            text-align: left;
            background-color: var(--light-color);
        }

        /* Dashboard KPI cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .kpi-card {
            background: var(--white-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
        }
        .kpi-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        .kpi-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        /* Chart containers */
        .chart-container {
            width: 100%;
            height: 350px;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center { text-align: center; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .mt-1 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 1rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .gap-1 { gap: 1rem; }

    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <h1>برنامج إدارة الاستثمار العقاري</h1>
        </div>
        <nav>
            <button class="nav-btn" data-page="dashboard-page">الرئيسية</button>
            <button class="nav-btn" data-page="units-page">الوحدات</button>
            <button class="nav-btn" data-page="partners-page">الشركاء</button>
            <button class="nav-btn" data-page="customers-page">العملاء</button>
            <button class="nav-btn" data-page="contracts-page">العقود</button>
            <button class="nav-btn" data-page="installments-page">الأقساط</button>
            <button class="nav-btn" data-page="payments-page">الدفعات</button>
            <button class="nav-btn" data-page="reports-page">التقارير</button>
            <button class="nav-btn" data-page="backup-page">حفظ وتحميل</button>
        </nav>
    </header>

    <main id="main-content">
        <div id="dashboard-page" class="page active">
            <h2>لوحة المعلومات</h2>
            <!-- Dashboard content will go here -->
        </div>
        <div id="units-page" class="page" style="display: none;">
            <h2>إدارة الوحدات</h2>
            <!-- Units content will go here -->
        </div>
        <div id="partners-page" class="page" style="display: none;">
            <h2>إدارة الشركاء</h2>
            <!-- Partners content will go here -->
        </div>
        <div id="customers-page" class="page" style="display: none;">
            <h2>إدارة العملاء</h2>
            <!-- Customers content will go here -->
        </div>
        <div id="contracts-page" class="page" style="display: none;">
            <h2>إدارة العقود</h2>
            <!-- Contracts content will go here -->
        </div>
        <div id="installments-page" class="page" style="display: none;">
            <h2>متابعة الأقساط</h2>
            <!-- Installments content will go here -->
        </div>
        <div id="payments-page" class="page" style="display: none;">
            <h2>سجل الدفعات</h2>
            <!-- Payments content will go here -->
        </div>
        <div id="reports-page" class="page" style="display: none;">
            <h2>التقارير</h2>
            <!-- Reports content will go here -->
        </div>
        <div id="backup-page" class="page" style="display: none;">
            <h2>حفظ وتحميل البيانات</h2>
            <!-- Backup/restore content will go here -->
        </div>
    </main>

    <div id="modal-backdrop" class="hidden">
        <div id="modal-container">
            <div id="modal-header">
                <h3 id="modal-title"></h3>
                <button id="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Modal content is injected here by JS -->
            </div>
            <div id="modal-footer">
                <!-- Modal action buttons are injected here by JS -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL APPLICATION OBJECT ---
            const app = {
                state: null,
                config: {}
            };

            const initialState = {
                units: [],
                partners: [],
                customers: [],
                contracts: [],
                installments: [],
                payments: [],
                nextUnitCode: 1,
            };

            // --- DOM ELEMENT REFERENCES ---
            const mainContent = document.getElementById('main-content');
            const navButtons = document.querySelectorAll('.nav-btn');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // --- UTILITY FUNCTIONS ---
            const uid = (prefix = 'id') => `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const egp = (amount) => new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP' }).format(amount != null ? amount : 0);
            const today = () => new Date().toISOString().split('T')[0];
            const parseNumber = (value, fallback = 0) => {
                const num = parseFloat(String(value).replace(/,/g, ''));
                return isNaN(num) ? fallback : num;
            };

            // --- CORE SYSTEMS ---

            /**
             * Loads initial state from localStorage.
             */
            function loadState() {
                const savedState = localStorage.getItem('realEstateState');
                if (savedState) {
                    app.state = JSON.parse(savedState);
                } else {
                    app.state = JSON.parse(JSON.stringify(initialState));
                }
            }

            /**
             * Saves the current state to localStorage.
             */
            function saveState() {
                localStorage.setItem('realEstateState', JSON.stringify(app.state));
            }


            // --- NAVIGATION ---

            function navigateTo(pageId) {
                document.querySelectorAll('.page').forEach(page => {
                    page.style.display = 'none';
                    page.classList.remove('active');
                });
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.style.display = 'block';
                    targetPage.classList.add('active');
                    renderPage(pageId);
                }

                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageId);
                });
            }

            function renderCurrentPage() {
                const activePage = document.querySelector('.page.active');
                if (activePage) {
                    renderPage(activePage.id);
                }
            }

            function renderPage(pageId) {
                const pageContainer = document.getElementById(pageId);
                if (!pageContainer) return;

                switch (pageId) {
                    case 'dashboard-page': renderDashboard(pageContainer); break;
                    case 'units-page': renderUnits(pageContainer); break;
                    case 'partners-page': renderPartners(pageContainer); break;
                    case 'customers-page': renderCustomers(pageContainer); break;
                    case 'contracts-page': renderContracts(pageContainer); break;
                    case 'installments-page': renderInstallments(pageContainer); break;
                    case 'payments-page': renderPayments(pageContainer); break;
                    case 'reports-page': renderReports(pageContainer); break;
                    case 'backup-page': renderBackup(pageContainer); break;
                }
            }

            function setupNavigation() {
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        navigateTo(button.dataset.page);
                    });
                });
            }

            // --- MODAL HELPERS ---
            function showModal(title, bodyHtml, footerHtml = '') {
                modalTitle.textContent = title;
                modalBody.innerHTML = bodyHtml;
                modalFooter.innerHTML = footerHtml;
                modalBackdrop.classList.remove('hidden');
            }

            function hideModal() {
                modalBackdrop.classList.add('hidden');
                modalTitle.textContent = '';
                modalBody.innerHTML = '';
                modalFooter.innerHTML = '';
            }

            function setupModal() {
                modalCloseBtn.addEventListener('click', hideModal);
                modalBackdrop.addEventListener('click', (e) => {
                    if (e.target === modalBackdrop) {
                        hideModal();
                    }
                });
            }

            // --- PAGE RENDER FUNCTIONS ---

            function renderDashboard(container) {
                const { units, contracts, payments, installments } = app.state;

                const soldUnitIds = new Set(contracts.map(c => c.unit_id));
                const totalUnits = units.length;
                const soldUnits = soldUnitIds.size;
                const availableUnits = totalUnits - soldUnits;

                const totalRevenue = contracts.reduce((sum, c) => sum + parseNumber(c.total_price), 0);
                const collectedRevenue = payments.reduce((sum, p) => sum + parseNumber(p.amount), 0);

                container.innerHTML = `
                    <div class="page-header">
                        <h2>لوحة المعلومات</h2>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <h3>إجمالي الوحدات</h3>
                            <div class="value">${totalUnits}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>الوحدات المتاحة</h3>
                            <div class="value">${availableUnits}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>إجمالي الإيرادات</h3>
                            <div class="value">${egp(totalRevenue)}</div>
                        </div>
                        <div class="kpi-card">
                            <h3>إجمالي المحصل</h3>
                            <div class="value">${egp(collectedRevenue)}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-1 mt-1">
                        <div class="card">
                            <h3>حالة الوحدات</h3>
                            <div id="unit-status-chart" class="chart-container"></div>
                        </div>
                        <div class="card">
                            <h3>التدفق النقدي المتوقع (6 أشهر)</h3>
                            <div id="cash-flow-chart" class="chart-container"></div>
                        </div>
                    </div>
                `;

                renderUnitStatusChart(soldUnits, availableUnits);
                renderCashFlowChart(installments);
            }

            function renderUnitStatusChart(sold, available) {
                const container = document.getElementById('unit-status-chart');
                const total = sold + available;
                if (total === 0) {
                    container.innerHTML = `<p class="text-center">لا توجد وحدات لعرضها.</p>`;
                    return;
                }

                const soldAngle = (sold / total) * 360;
                const soldColor = 'var(--primary-color)';
                const availableColor = 'var(--secondary-color)';
                const soldPath = getDonutSegment(150, 150, 100, 70, 0, soldAngle);
                const availablePath = getDonutSegment(150, 150, 100, 70, soldAngle, 360);

                container.innerHTML = `
                    <svg viewBox="0 0 300 300">
                        ${sold > 0 ? `<path d="${soldPath}" fill="${soldColor}"></path>` : ''}
                        ${available > 0 ? `<path d="${availablePath}" fill="${availableColor}"></path>` : ''}
                    </svg>
                    <div style="display:flex; justify-content:center; gap: 20px; margin-top: 10px;">
                        <span style="color:${soldColor};">■ مباع (${sold})</span>
                        <span style="color:${availableColor};">■ متاح (${available})</span>
                    </div>
                `;
            }

            function getDonutSegment(cx, cy, radius, innerRadius, startAngle, endAngle) {
                if (endAngle - startAngle >= 360) endAngle = startAngle + 359.99;
                const start = polarToCartesian(cx, cy, radius, endAngle);
                const end = polarToCartesian(cx, cy, radius, startAngle);
                const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
                const start2 = polarToCartesian(cx, cy, innerRadius, endAngle);
                const end2 = polarToCartesian(cx, cy, innerRadius, startAngle);

                return [
                    "M", start.x, start.y,
                    "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
                    "L", end2.x, end2.y,
                    "A", innerRadius, innerRadius, 0, largeArcFlag, 1, start2.x, start2.y,
                    "Z"
                ].join(" ");
            }

            function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
                const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                return {
                    x: centerX + (radius * Math.cos(angleInRadians)),
                    y: centerY + (radius * Math.sin(angleInRadians))
                };
            }

            function renderCashFlowChart(installments) {
                const container = document.getElementById('cash-flow-chart');
                const data = { labels: [], series: [[]] };
                const now = new Date();

                for (let i = 0; i < 6; i++) {
                    const month = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    data.labels.push(month.toLocaleDateString('ar-EG', { month: 'short' }));
                    data.series[0].push(0);
                }

                installments.forEach(inst => {
                    if (inst.status !== 'مدفوع' && inst.due_date) {
                        const dueDate = new Date(inst.due_date);
                        const monthDiff = (dueDate.getFullYear() - now.getFullYear()) * 12 + dueDate.getMonth() - now.getMonth();
                        if (monthDiff >= 0 && monthDiff < 6) {
                            data.series[0][monthDiff] += parseNumber(inst.amount);
                        }
                    }
                });

                if (data.series[0].every(v => v === 0)) {
                    container.innerHTML = `<p class="text-center">لا توجد تدفقات نقدية متوقعة في الشهور القادمة.</p>`;
                    return;
                }

                container.innerHTML = createBarChart(data);
            }

            function createBarChart(data) {
                const { labels, series } = data;
                const maxVal = Math.max(...series[0]);
                const width = 300, height = 300, padding = 40;
                const barWidth = (width - padding * 2) / labels.length * 0.6;
                const barSpacing = (width - padding * 2) / labels.length * 0.4;

                let bars = '';
                series[0].forEach((val, i) => {
                    const barHeight = maxVal > 0 ? (val / maxVal) * (height - padding * 2) : 0;
                    const x = padding + i * (barWidth + barSpacing);
                    const y = height - padding - barHeight;
                    bars += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="var(--secondary-color)"></rect>
                             <text x="${x + barWidth / 2}" y="${y - 5}" text-anchor="middle" font-size="10">${egp(val).replace('ج.م.‏', '')}</text>`;
                });

                let xLabels = '';
                labels.forEach((label, i) => {
                    const x = padding + i * (barWidth + barSpacing) + barWidth / 2;
                    xLabels += `<text x="${x}" y="${height - padding + 15}" text-anchor="middle" font-size="12">${label}</text>`;
                });

                return `
                    <svg viewBox="0 0 ${width} ${height}">
                        <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#ccc"></line>
                        ${bars}
                        ${xLabels}
                    </svg>
                `;
            }

            function renderUnits(container) {
                const soldUnitIds = new Set(app.state.contracts.map(c => c.unit_id));

                container.innerHTML = `
                    <div class="page-header">
                        <h2>إدارة الوحدات (${app.state.units.length})</h2>
                        <div>
                            <button id="add-unit-btn" class="btn">إضافة وحدة جديدة</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>الكود</th>
                                    <th>الاسم</th>
                                    <th>البرج</th>
                                    <th>الطابق</th>
                                    <th>السعر</th>
                                    <th>الحالة</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${app.state.units.map(unit => `
                                    <tr>
                                        <td>${unit.code}</td>
                                        <td>${unit.name || '—'}</td>
                                        <td>${unit.tower || '—'}</td>
                                        <td>${unit.floor || '—'}</td>
                                        <td>${egp(unit.price)}</td>
                                        <td>${soldUnitIds.has(unit.id) ? 'مباعة' : 'متاحة'}</td>
                                        <td class="actions">
                                            <button class="btn neutral btn-sm" onclick="showPartnerManagement('${unit.id}')">الشركاء</button>
                                            <button class="btn btn-sm" onclick="showUnitForm('${unit.id}')">تعديل</button>
                                            <button class="btn warn btn-sm" onclick="handleDeleteUnit('${unit.id}')">حذف</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('add-unit-btn').addEventListener('click', () => showUnitForm());
            }

            function showUnitForm(unitId = null) {
                const unit = unitId ? app.state.units.find(u => u.id === unitId) : null;
                const isEdit = unit !== null;
                const title = isEdit ? 'تعديل وحدة' : 'إضافة وحدة جديدة';

                const bodyHtml = `
                    <form id="unit-form">
                         <div class="grid grid-cols-2 gap-1">
                            <div class="form-group">
                                <label for="unit-code">كود الوحدة</label>
                                <input type="text" id="unit-code" class="input" value="${isEdit ? unit.code : ''}" placeholder="مثال: U101" required>
                            </div>
                            <div class="form-group">
                                <label for="unit-name">اسم الوحدة</label>
                                <input type="text" id="unit-name" class="input" value="${isEdit && unit.name ? unit.name : ''}" placeholder="مثال: شقة 101">
                            </div>
                            <div class="form-group">
                                <label for="unit-tower">البرج</label>
                                <input type="text" id="unit-tower" class="input" value="${isEdit && unit.tower ? unit.tower : ''}" placeholder="مثال: برج أ">
                            </div>
                            <div class="form-group">
                                <label for="unit-floor">الطابق</label>
                                <input type="text" id="unit-floor" class="input" value="${isEdit && unit.floor ? unit.floor : ''}">
                            </div>
                             <div class="form-group">
                                <label for="unit-type">نوع الوحدة</label>
                                <select id="unit-type" class="input">
                                    <option value="سكني" ${isEdit && unit.unit_type === 'سكني' ? 'selected' : ''}>سكني</option>
                                    <option value="تجاري" ${isEdit && unit.unit_type === 'تجاري' ? 'selected' : ''}>تجاري</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="unit-area">المساحة (م²)</label>
                                <input type="number" id="unit-area" class="input" value="${isEdit ? unit.area : ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="unit-price">السعر</label>
                            <input type="number" id="unit-price" class="input" value="${isEdit ? unit.price : ''}">
                        </div>
                         <div class="form-group">
                            <label for="unit-notes">ملاحظات</label>
                            <textarea id="unit-notes" class="input">${isEdit ? unit.notes || '' : ''}</textarea>
                        </div>
                    </form>
                `;

                const footerHtml = `<button id="save-unit-btn" class="btn ok">${isEdit ? 'حفظ التعديلات' : 'إضافة الوحدة'}</button>`;

                showModal(title, bodyHtml, footerHtml);

                document.getElementById('save-unit-btn').addEventListener('click', () => handleSaveUnit(unitId));
            }

            function handleSaveUnit(unitId) {
                const isEdit = unitId !== null;
                const unitCode = document.getElementById('unit-code').value.trim();

                if (!unitCode) {
                    alert('كود الوحدة مطلوب.');
                    return;
                }

                const codeExists = app.state.units.some(u => u.code === unitCode && u.id !== unitId);
                if (codeExists) {
                    alert('كود الوحدة موجود بالفعل. الرجاء اختيار كود آخر.');
                    return;
                }

                const unitData = {
                    id: isEdit ? unitId : uid('unit'),
                    code: unitCode,
                    name: document.getElementById('unit-name').value.trim(),
                    tower: document.getElementById('unit-tower').value.trim(),
                    floor: document.getElementById('unit-floor').value.trim(),
                    unit_type: document.getElementById('unit-type').value,
                    area: parseNumber(document.getElementById('unit-area').value),
                    price: parseNumber(document.getElementById('unit-price').value),
                    notes: document.getElementById('unit-notes').value,
                    partners: isEdit ? app.state.units.find(u => u.id === unitId).partners : []
                };

                if (isEdit) {
                    app.state.units = app.state.units.map(u => u.id === unitId ? unitData : u);
                } else {
                    app.state.units.push(unitData);
                }

                saveState();
                hideModal();
                renderPage('units-page');
            }

            function handleDeleteUnit(unitId) {
                const isUnitSold = app.state.contracts.some(c => c.unit_id === unitId);
                if (isUnitSold) {
                    alert('لا يمكن حذف وحدة مباعة.');
                    return;
                }

                if (window.confirm('هل أنت متأكد من رغبتك في حذف هذه الوحدة؟')) {
                    app.state.units = app.state.units.filter(u => u.id !== unitId);
                    saveState();
                    renderPage('units-page');
                }
            }

            window.showUnitForm = showUnitForm;
            window.handleDeleteUnit = handleDeleteUnit;

            function showPartnerManagement(unitId) {
                const unit = app.state.units.find(u => u.id === unitId);
                if (!unit) {
                    alert('لم يتم العثور على الوحدة.');
                    return;
                }
                const title = `إدارة شركاء الوحدة: ${unit.code}`;
                showModal(title, '<div id="partner-modal-body"></div>', `<button class="btn neutral" onclick="hideModal()">إغلاق</button>`);
                renderPartnerManagementModal(unitId);
            }

            function renderPartnerManagementModal(unitId) {
                const unit = app.state.units.find(u => u.id === unitId);
                const modalBodyContainer = document.getElementById('partner-modal-body');

                const assignedPartnerIds = new Set(unit.partners.map(p => p.partner_id));
                const availablePartners = app.state.partners.filter(p => !assignedPartnerIds.has(p.id));
                const currentTotalOwnership = unit.partners.reduce((sum, p) => sum + parseNumber(p.ownership), 0);

                let partnersListHtml = `<h4>الشركاء الحاليون (${currentTotalOwnership}%)</h4>`;
                if (unit.partners.length > 0) {
                    partnersListHtml += `
                        <ul style="list-style: none; padding: 0;">
                            ${unit.partners.map(p => {
                                const partnerInfo = app.state.partners.find(ap => ap.id === p.partner_id);
                                return `<li class="d-flex justify-between align-center mb-1">
                                    <span>${partnerInfo ? partnerInfo.name : 'شريك محذوف'} - ${p.ownership}%</span>
                                    <button class="btn warn btn-sm" onclick="handleRemovePartnerFromUnit('${unit.id}', '${p.partner_id}')">إزالة</button>
                                </li>`;
                            }).join('')}
                        </ul>`;
                } else {
                    partnersListHtml += '<p>لا يوجد شركاء معينون لهذه الوحدة بعد.</p>';
                }

                let addPartnerFormHtml = `
                    <hr style="margin: 1.5rem 0;">
                    <h4>إضافة شريك جديد</h4>
                    <form id="add-partner-form">
                        <div class="form-group">
                            <label for="partner-select">اختر شريك</label>
                            <select id="partner-select" class="input" ${availablePartners.length === 0 ? 'disabled' : ''}>
                                ${availablePartners.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                ${availablePartners.length === 0 ? '<option>لا يوجد شركاء متاحون</option>' : ''}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="partner-ownership">نسبة الملكية (%)</label>
                            <input type="number" id="partner-ownership" class="input" placeholder="e.g., 50">
                        </div>
                        <button type="button" id="add-partner-to-unit-btn" class="btn" ${availablePartners.length === 0 ? 'disabled' : ''}>إضافة شريك</button>
                    </form>
                `;

                modalBodyContainer.innerHTML = partnersListHtml + addPartnerFormHtml;

                document.getElementById('add-partner-to-unit-btn').addEventListener('click', () => handleAddPartnerToUnit(unitId));
            }

            function handleAddPartnerToUnit(unitId) {
                const partnerId = document.getElementById('partner-select').value;
                const ownership = parseNumber(document.getElementById('partner-ownership').value);

                if (!partnerId) { alert('الرجاء اختيار شريك.'); return; }
                if (ownership <= 0 || ownership > 100) { alert('الرجاء إدخال نسبة ملكية صحيحة (بين 1 و 100).'); return; }

                const unit = app.state.units.find(u => u.id === unitId);
                const currentTotalOwnership = unit.partners.reduce((sum, p) => sum + parseNumber(p.ownership), 0);

                if (currentTotalOwnership + ownership > 100.01) { // Use tolerance for float comparison
                    alert(`لا يمكن إضافة هذه النسبة. إجمالي الملكية سيتجاوز 100%. المتبقي: ${100 - currentTotalOwnership}%`);
                    return;
                }

                app.state.units = app.state.units.map(u => {
                    if (u.id === unitId) {
                        u.partners.push({ unit_id: unitId, partner_id: partnerId, ownership: ownership });
                    }
                    return u;
                });

                saveState();
                renderPartnerManagementModal(unitId);
            }

            function handleRemovePartnerFromUnit(unitId, partnerId) {
                app.state.units = app.state.units.map(u => {
                    if (u.id === unitId) {
                        u.partners = u.partners.filter(p => p.partner_id !== partnerId);
                    }
                    return u;
                });
                saveState();
                renderPartnerManagementModal(unitId);
            }

            window.showPartnerManagement = showPartnerManagement;
            window.handleRemovePartnerFromUnit = handleRemovePartnerFromUnit;

            function renderPartners(container) {
                container.innerHTML = `
                    <div class="page-header">
                        <h2>إدارة الشركاء (${app.state.partners.length})</h2>
                        <div>
                            <button id="add-partner-btn" class="btn">إضافة شريك جديد</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>الهاتف</th>
                                    <th>ملاحظات</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${app.state.partners.map(p => `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.phone || '—'}</td>
                                        <td>${p.notes || '—'}</td>
                                        <td class="actions">
                                            <button class="btn btn-sm" onclick="showPartnerForm('${p.id}')">تعديل</button>
                                            <button class="btn warn btn-sm" onclick="handleDeletePartner('${p.id}')">حذف</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('add-partner-btn').addEventListener('click', () => showPartnerForm());
            }

            function showPartnerForm(partnerId = null) {
                const partner = partnerId ? app.state.partners.find(p => p.id === partnerId) : null;
                const isEdit = partner !== null;
                const title = isEdit ? 'تعديل بيانات شريك' : 'إضافة شريك جديد';

                const bodyHtml = `
                    <form id="partner-form">
                        <div class="form-group">
                            <label for="partner-name">الاسم</label>
                            <input type="text" id="partner-name" class="input" value="${isEdit ? partner.name : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="partner-phone">الهاتف</label>
                            <input type="tel" id="partner-phone" class="input" value="${isEdit ? partner.phone || '' : ''}">
                        </div>
                        <div class="form-group">
                            <label for="partner-notes">ملاحظات</label>
                            <textarea id="partner-notes" class="input">${isEdit ? partner.notes || '' : ''}</textarea>
                        </div>
                    </form>
                `;
                const footerHtml = `<button id="save-partner-btn" class="btn ok">${isEdit ? 'حفظ التعديلات' : 'إضافة'}</button>`;

                showModal(title, bodyHtml, footerHtml);

                document.getElementById('save-partner-btn').addEventListener('click', () => handleSavePartner(partnerId));
            }

            function handleSavePartner(partnerId) {
                const name = document.getElementById('partner-name').value.trim();
                if (!name) {
                    alert('اسم الشريك مطلوب.');
                    return;
                }

                const partnerData = {
                    id: partnerId || uid('partner'),
                    name,
                    phone: document.getElementById('partner-phone').value.trim(),
                    notes: document.getElementById('partner-notes').value.trim()
                };

                if (partnerId) {
                    app.state.partners = app.state.partners.map(p => p.id === partnerId ? partnerData : p);
                } else {
                    app.state.partners.push(partnerData);
                }

                saveState();
                hideModal();
                renderPage('partners-page');
            }

            function handleDeletePartner(partnerId) {
                const isPartnerInUnit = app.state.units.some(u => u.partners.some(p => p.partner_id === partnerId));
                if (isPartnerInUnit) {
                    alert('لا يمكن حذف شريك مرتبط بوحدة. يجب إزالته من الوحدة أولاً.');
                    return;
                }

                if (window.confirm('هل أنت متأكد من حذف هذا الشريك؟')) {
                    app.state.partners = app.state.partners.filter(p => p.id !== partnerId);
                    saveState();
                    renderPage('partners-page');
                }
            }

            window.showPartnerForm = showPartnerForm;
            window.handleDeletePartner = handleDeletePartner;

            function renderCustomers(container) {
                container.innerHTML = `
                    <div class="page-header">
                        <h2>إدارة العملاء (${app.state.customers.length})</h2>
                        <div>
                            <button id="add-customer-btn" class="btn">إضافة عميل جديد</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>الهاتف</th>
                                    <th>العنوان</th>
                                    <th>الحالة</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${app.state.customers.map(c => `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td>${c.phone || '—'}</td>
                                        <td>${c.address || '—'}</td>
                                        <td><span style="color: ${c.status === 'نشط' ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: bold;">${c.status || 'نشط'}</span></td>
                                        <td class="actions">
                                            <button class="btn btn-sm" onclick="showCustomerForm('${c.id}')">تعديل</button>
                                            <button class="btn warn btn-sm" onclick="handleDeleteCustomer('${c.id}')">حذف</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('add-customer-btn').addEventListener('click', () => showCustomerForm());
            }

            function showCustomerForm(customerId = null) {
                const customer = customerId ? app.state.customers.find(c => c.id === customerId) : null;
                const isEdit = customer !== null;
                const title = isEdit ? 'تعديل بيانات عميل' : 'إضافة عميل جديد';

                const bodyHtml = `
                    <form id="customer-form">
                        <div class="grid grid-cols-2 gap-1">
                            <div class="form-group">
                                <label for="customer-name">الاسم</label>
                                <input type="text" id="customer-name" class="input" value="${isEdit ? customer.name : ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="customer-phone">الهاتف</label>
                                <input type="tel" id="customer-phone" class="input" value="${isEdit ? customer.phone || '' : ''}">
                            </div>
                            <div class="form-group">
                                <label for="customer-national-id">الرقم القومي</label>
                                <input type="text" id="customer-national-id" class="input" value="${isEdit && customer.national_id ? customer.national_id : ''}">
                            </div>
                             <div class="form-group">
                                <label for="customer-status">الحالة</label>
                                <select id="customer-status" class="input">
                                    <option value="نشط" ${!isEdit || (isEdit && customer.status === 'نشط') ? 'selected' : ''}>نشط</option>
                                    <option value="موقوف" ${isEdit && customer.status === 'موقوف' ? 'selected' : ''}>موقوف</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customer-address">العنوان</label>
                            <input type="text" id="customer-address" class="input" value="${isEdit && customer.address ? customer.address : ''}">
                        </div>
                        <div class="form-group">
                            <label for="customer-notes">ملاحظات</label>
                            <textarea id="customer-notes" class="input">${isEdit ? customer.notes || '' : ''}</textarea>
                        </div>
                    </form>
                `;
                const footerHtml = `<button id="save-customer-btn" class="btn ok">${isEdit ? 'حفظ التعديلات' : 'إضافة'}</button>`;

                showModal(title, bodyHtml, footerHtml);
                document.getElementById('save-customer-btn').addEventListener('click', () => handleSaveCustomer(customerId));
            }

            function handleSaveCustomer(customerId) {
                const name = document.getElementById('customer-name').value.trim();
                const phone = document.getElementById('customer-phone').value.trim();

                if (!name || !phone) {
                    alert('الاسم ورقم الهاتف حقول إلزامية.');
                    return;
                }

                const isDuplicate = app.state.customers.some(
                    c => c.id !== customerId && (c.name === name || c.phone === phone)
                );

                if (isDuplicate) {
                    alert('يوجد عميل آخر بنفس الاسم أو رقم الهاتف.');
                    return;
                }

                const customerData = {
                    id: customerId || uid('customer'),
                    name,
                    phone,
                    national_id: document.getElementById('customer-national-id').value.trim(),
                    address: document.getElementById('customer-address').value.trim(),
                    status: document.getElementById('customer-status').value,
                    notes: document.getElementById('customer-notes').value.trim()
                };

                if (customerId) {
                    app.state.customers = app.state.customers.map(c => c.id === customerId ? customerData : c);
                } else {
                    app.state.customers.push(customerData);
                }

                saveState();
                hideModal();
                renderPage('customers-page');
            }

            function handleDeleteCustomer(customerId) {
                const isCustomerInContract = app.state.contracts.some(c => c.customer_id === customerId);
                if (isCustomerInContract) {
                    alert('لا يمكن حذف عميل مرتبط بعقد. يجب إلغاء العقد أولاً.');
                    return;
                }

                if (window.confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                    app.state.customers = app.state.customers.filter(c => c.id !== customerId);
                    saveState();
                    renderPage('customers-page');
                }
            }

            window.showCustomerForm = showCustomerForm;
            window.handleDeleteCustomer = handleDeleteCustomer;

            function renderContracts(container) {
                const { contracts, units, customers, payments } = app.state;
                container.innerHTML = `
                    <div class="page-header">
                        <h2>إدارة العقود (${contracts.length})</h2>
                        <div>
                            <button id="add-contract-btn" class="btn">إضافة عقد جديد</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>كود الوحدة</th>
                                    <th>العميل</th>
                                    <th>السعر الإجمالي</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${contracts.map(c => {
                                    const unit = units.find(u => u.id === c.unit_id);
                                    const customer = customers.find(cust => cust.id === c.customer_id);
                                    const paidAmount = payments.filter(p => p.contract_id === c.id).reduce((sum, p) => sum + p.amount, 0);
                                    const remaining = c.total_price - paidAmount;
                                    return `
                                        <tr>
                                            <td>${unit ? unit.code : 'محذوفة'}</td>
                                            <td>${customer ? customer.name : 'محذوف'}</td>
                                            <td>${egp(c.total_price)}</td>
                                            <td>${egp(paidAmount)}</td>
                                            <td style="color: ${remaining > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">${egp(remaining)}</td>
                                            <td class="actions">
                                                <button class="btn neutral btn-sm" onclick="showContractDetails('${c.id}')">تفاصيل</button>
                                                <button class="btn warn btn-sm" onclick="handleCancelContract('${c.id}')">إلغاء</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('add-contract-btn').addEventListener('click', () => showContractForm());
            }

            function showContractForm() {
                const soldUnitIds = new Set(app.state.contracts.map(c => c.unit_id));
                const availableUnits = app.state.units.filter(u => !soldUnitIds.has(u.id));
                const customers = app.state.customers;

                if (availableUnits.length === 0) { alert('لا توجد وحدات متاحة لإنشاء عقد.'); return; }
                if (customers.length === 0) { alert('يجب إضافة عملاء أولاً.'); return; }

                const title = 'إضافة عقد جديد';
                const bodyHtml = `
                    <form id="contract-form">
                        <div class="form-group">
                            <label for="contract-unit">اختر وحدة</label>
                            <select id="contract-unit" class="input">${availableUnits.map(u => `<option value="${u.id}" data-price="${u.price}">${u.code} - ${u.unit_type} (${u.area}م²)</option>`).join('')}</select>
                        </div>
                        <div class="form-group">
                            <label for="contract-customer">اختر عميل</label>
                            <select id="contract-customer" class="input">${customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>
                        </div>
                        <div class="form-group">
                            <label for="contract-price">السعر الإجمالي</label>
                            <input type="number" id="contract-price" class="input" placeholder="سيتم ملؤه من سعر الوحدة تلقائياً">
                        </div>
                        <div class="form-group">
                            <label for="contract-downpayment">دفعة مقدمة</label>
                            <input type="number" id="contract-downpayment" class="input" value="0">
                        </div>
                        <hr>
                        <h4>تفاصيل الأقساط</h4>
                        <div class="form-group">
                            <label for="contract-installments-num">عدد الأقساط</label>
                            <input type="number" id="contract-installments-num" class="input" value="12">
                        </div>
                        <div class="form-group">
                            <label for="contract-start-date">تاريخ أول قسط</label>
                            <input type="date" id="contract-start-date" class="input" value="${today()}">
                        </div>
                        <div id="installments-preview"></div>
                    </form>
                `;
                const footerHtml = `
                    <button type="button" id="preview-installments-btn" class="btn neutral">معاينة الأقساط</button>
                    <button type="button" id="save-contract-btn" class="btn ok">حفظ العقد</button>
                `;

                showModal(title, bodyHtml, footerHtml);

                const unitSelect = document.getElementById('contract-unit');
                const priceInput = document.getElementById('contract-price');

                function updatePrice() {
                     const selectedOption = unitSelect.options[unitSelect.selectedIndex];
                     if(selectedOption) {
                        priceInput.value = selectedOption.dataset.price;
                     }
                }
                updatePrice(); // Set initial price
                unitSelect.addEventListener('change', updatePrice);

                document.getElementById('preview-installments-btn').addEventListener('click', previewInstallments);
                document.getElementById('save-contract-btn').addEventListener('click', handleSaveContract);
            }

            function previewInstallments() {
                const previewContainer = document.getElementById('installments-preview');
                try {
                    const totalPrice = parseNumber(document.getElementById('contract-price').value);
                    const downPayment = parseNumber(document.getElementById('contract-downpayment').value);
                    const numInstallments = parseNumber(document.getElementById('contract-installments-num').value);
                    const startDate = document.getElementById('contract-start-date').value;

                    const installments = generateInstallments(totalPrice, downPayment, numInstallments, startDate);

                    previewContainer.innerHTML = `
                        <h5>معاينة (${installments.length} قسط):</h5>
                        <p>قيمة كل قسط: ${egp(installments.length > 0 ? installments[0].amount : 0)}</p>
                        <p>يبدأ من: ${installments.length > 0 ? installments[0].due_date : 'N/A'}</p>
                        <p>ينتهي في: ${installments.length > 0 ? installments[installments.length - 1].due_date : 'N/A'}</p>
                    `;
                } catch (e) {
                    previewContainer.innerHTML = `<p style="color:var(--danger-color);">${e.message}</p>`;
                }
            }

            function generateInstallments(totalPrice, downPayment, numInstallments, startDate) {
                if (numInstallments <= 0) return [];
                const remainingAmount = totalPrice - downPayment;
                if (remainingAmount < 0) throw new Error('المقدم لا يمكن أن يكون أكبر من السعر الإجمالي.');

                const installmentAmount = Math.round((remainingAmount / numInstallments) * 100) / 100;
                const installments = [];
                let currentDate = new Date(startDate);

                for (let i = 0; i < numInstallments; i++) {
                    installments.push({
                        id: uid('inst'),
                        amount: installmentAmount,
                        due_date: currentDate.toISOString().split('T')[0],
                        status: 'غير مدفوع'
                    });
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                return installments;
            }

            function handleSaveContract() {
                const contractData = {
                    id: uid('contract'),
                    unit_id: document.getElementById('contract-unit').value,
                    customer_id: document.getElementById('contract-customer').value,
                    total_price: parseNumber(document.getElementById('contract-price').value),
                    down_payment: parseNumber(document.getElementById('contract-downpayment').value),
                    contract_date: today()
                };

                if (!contractData.unit_id || !contractData.customer_id || !contractData.total_price) {
                    alert('الرجاء ملء جميع الحقول المطلوبة.');
                    return;
                }

                const numInstallments = parseNumber(document.getElementById('contract-installments-num').value);
                const startDate = document.getElementById('contract-start-date').value;
                const newInstallments = generateInstallments(contractData.total_price, contractData.down_payment, numInstallments, startDate);
                newInstallments.forEach(inst => inst.contract_id = contractData.id);

                app.state.contracts.push(contractData);
                app.state.installments.push(...newInstallments);

                if (contractData.down_payment > 0) {
                    const downPayment = {
                        id: uid('payment'),
                        contract_id: contractData.id,
                        installment_id: null,
                        amount: contractData.down_payment,
                        date: today(),
                        method: 'مقدم'
                    };
                    app.state.payments.push(downPayment);
                }

                saveState();
                hideModal();
                renderPage('contracts-page');
            }

            window.showContractForm = showContractForm;
            window.previewInstallments = previewInstallments;
            window.handleSaveContract = handleSaveContract;

            function showContractDetails(contractId) {
                const { contracts, units, customers, installments, payments } = app.state;
                const contract = contracts.find(c => c.id === contractId);
                if (!contract) { alert('لم يتم العثور على العقد.'); return; }

                const unit = units.find(u => u.id === contract.unit_id);
                const customer = customers.find(c => c.id === contract.customer_id);
                const contractInstallments = installments.filter(i => i.contract_id === contractId).sort((a,b) => a.due_date.localeCompare(b.due_date));
                const totalPaid = payments.filter(p => p.contract_id === contractId).reduce((sum, p) => sum + p.amount, 0);

                const title = `تفاصيل العقد - ${unit ? unit.code : 'N/A'}`;
                let bodyHtml = `
                    <h4>بيانات العقد الأساسية</h4>
                    <p><strong>العميل:</strong> ${customer ? customer.name : 'محذوف'}</p>
                    <p><strong>الوحدة:</strong> ${unit ? `${unit.code} (${unit.unit_type})` : 'محذوفة'}</p>
                    <p><strong>تاريخ العقد:</strong> ${contract.contract_date}</p>
                    <p><strong>السعر الإجمالي:</strong> ${egp(contract.total_price)}</p>
                    <p><strong>إجمالي المدفوع:</strong> ${egp(totalPaid)}</p>
                    <p><strong>المتبقي:</strong> ${egp(contract.total_price - totalPaid)}</p>
                    <hr>
                    <h4>جدول الأقساط</h4>
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table class="table">
                            <thead><tr><th>المبلغ</th><th>تاريخ الاستحقاق</th><th>الحالة</th></tr></thead>
                            <tbody>
                                ${contractInstallments.map(inst => `
                                    <tr class="${inst.status === 'مدفوع' ? 'paid' : ''}">
                                        <td>${egp(inst.amount)}</td>
                                        <td>${inst.due_date}</td>
                                        <td>${inst.status}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                showModal(title, bodyHtml, `<button class="btn neutral" onclick="hideModal()">إغلاق</button>`);
            }

            function handleCancelContract(contractId) {
                const hasPayments = app.state.payments.some(p => p.contract_id === contractId);
                if (hasPayments) {
                    alert('لا يمكن إلغاء هذا العقد لوجود دفعات مسجلة عليه. يجب حذف الدفعات يدوياً أولاً.');
                    return;
                }

                if (window.confirm('هل أنت متأكد من إلغاء هذا العقد؟ سيتم حذف جميع الأقساط المرتبطة به.')) {
                    app.state.contracts = app.state.contracts.filter(c => c.id !== contractId);
                    app.state.installments = app.state.installments.filter(i => i.contract_id !== contractId);
                    saveState();
                    renderPage('contracts-page');
                }
            }

            window.showContractDetails = showContractDetails;
            window.handleCancelContract = handleCancelContract;

            function renderInstallments(container) {
                const { installments, units, contracts, customers } = app.state;

                const unitMap = new Map(units.map(u => [u.id, u]));
                const customerMap = new Map(customers.map(c => [c.id, c]));
                const contractMap = new Map(contracts.map(c => [c.id, c]));

                container.innerHTML = `
                    <div class="page-header">
                        <h2>متابعة الأقساط (${installments.length})</h2>
                        <div class="d-flex align-center">
                            <input type="text" id="installments-search" class="input" placeholder="بحث..." style="width: 300px; margin-bottom: 0;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>الوحدة</th>
                                    <th>العميل</th>
                                    <th>المبلغ المستحق</th>
                                    <th>تاريخ الاستحقاق</th>
                                    <th>الحالة</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="installments-table-body">
                            </tbody>
                        </table>
                    </div>
                `;

                const tableBody = document.getElementById('installments-table-body');
                const searchInput = document.getElementById('installments-search');

                function filterAndRender() {
                    const query = searchInput.value.toLowerCase();
                    const filteredInstallments = installments.filter(inst => {
                        const contract = contractMap.get(inst.contract_id);
                        if (!contract) return false;
                        const unit = unitMap.get(contract.unit_id);
                        const customer = customerMap.get(contract.customer_id);
                        const searchText = `
                            ${unit ? unit.code : ''}
                            ${customer ? customer.name : ''}
                            ${inst.status}
                        `.toLowerCase();
                        return searchText.includes(query);
                    });

                    tableBody.innerHTML = filteredInstallments.sort((a,b) => a.due_date.localeCompare(b.due_date)).map(inst => {
                        const contract = contractMap.get(inst.contract_id);
                        const unit = unitMap.get(contract.unit_id);
                        const customer = customerMap.get(contract.customer_id);

                        let rowClass = '';
                        if (inst.status === 'مدفوع') {
                            rowClass = 'paid';
                        } else if (inst.due_date && new Date(inst.due_date) < new Date(today())) {
                            rowClass = 'overdue';
                        } else if (inst.due_date) {
                            const sevenDaysFromNow = new Date();
                            sevenDaysFromNow.setDate(new Date().getDate() + 7);
                            if (new Date(inst.due_date) <= sevenDaysFromNow) {
                                rowClass = 'due-soon';
                            }
                        }

                        return `
                            <tr class="${rowClass}">
                                <td>${unit ? unit.code : 'N/A'}</td>
                                <td>${customer ? customer.name : 'N/A'}</td>
                                <td>${egp(inst.amount)}</td>
                                <td>${inst.due_date}</td>
                                <td>${inst.status}</td>
                                <td class="actions">
                                    <button class="btn ok btn-sm" onclick="showPaymentModal('${inst.id}')" ${inst.status === 'مدفوع' ? 'disabled' : ''}>دفع</button>
                                    <button class="btn warn btn-sm" onclick="handleDeleteInstallment('${inst.id}')" ${inst.status === 'مدفوع' ? 'disabled' : ''}>حذف</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                searchInput.addEventListener('input', filterAndRender);
                filterAndRender();
            }

            function showPaymentModal(installmentId) {
                const installment = app.state.installments.find(i => i.id === installmentId);
                if (!installment) { alert('لم يتم العثور على القسط.'); return; }

                const title = 'تسجيل دفعة';
                const bodyHtml = `
                    <form id="payment-form">
                        <p><strong>المبلغ المستحق:</strong> ${egp(installment.amount)}</p>
                        <div class="form-group">
                            <label for="payment-amount">المبلغ المدفوع</label>
                            <input type="number" id="payment-amount" class="input" value="${installment.amount}" max="${installment.amount}" min="0.01">
                        </div>
                         <div class="form-group">
                            <label for="payment-date">تاريخ الدفع</label>
                            <input type="date" id="payment-date" class="input" value="${today()}">
                        </div>
                    </form>
                `;
                const footerHtml = `<button id="save-payment-btn" class="btn ok">حفظ الدفعة</button>`;

                showModal(title, bodyHtml, footerHtml);
                document.getElementById('save-payment-btn').addEventListener('click', () => handleSavePayment(installment.id));
            }

            function handleSavePayment(installmentId) {
                const amount = parseNumber(document.getElementById('payment-amount').value);
                if (amount <= 0) {
                    alert('الرجاء إدخال مبلغ صحيح.');
                    return;
                }

                const installment = app.state.installments.find(i => i.id === installmentId);
                if (amount > installment.amount) {
                    alert('المبلغ المدفوع أكبر من المبلغ المستحق.');
                    return;
                }

                const newPayment = {
                    id: uid('payment'),
                    contract_id: installment.contract_id,
                    installment_id: installment.id,
                    amount: amount,
                    date: document.getElementById('payment-date').value,
                    method: 'قسط'
                };
                app.state.payments.push(newPayment);

                installment.amount -= amount;
                if (installment.amount < 0.01) {
                    installment.status = 'مدفوع';
                }

                saveState();
                hideModal();
                renderPage('installments-page');
                renderPage('payments-page');
            }

            window.showPaymentModal = showPaymentModal;

            function handleDeleteInstallment(installmentId) {
                if (window.confirm('هل أنت متأكد من حذف هذا القسط؟ لا يمكن التراجع عن هذا الإجراء.')) {
                    app.state.installments = app.state.installments.filter(i => i.id !== installmentId);
                    saveState();
                    renderPage('installments-page');
                }
            }

            window.handleDeleteInstallment = handleDeleteInstallment;

            function renderPayments(container) {
                 const { payments, units, contracts, customers } = app.state;

                const unitMap = new Map(units.map(u => [u.id, u]));
                const customerMap = new Map(customers.map(c => [c.id, c]));
                const contractMap = new Map(contracts.map(c => [c.id, c]));

                container.innerHTML = `
                    <div class="page-header">
                        <h2>سجل الدفعات (${payments.length})</h2>
                        <div class="d-flex align-center">
                            <input type="text" id="payments-search" class="input" placeholder="بحث..." style="width: 300px; margin-bottom: 0;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>الوحدة</th>
                                    <th>العميل</th>
                                    <th>المبلغ</th>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="payments-table-body"></tbody>
                        </table>
                    </div>
                `;

                const tableBody = document.getElementById('payments-table-body');
                const searchInput = document.getElementById('payments-search');

                function filterAndRender() {
                    const query = searchInput.value.toLowerCase();
                    const filteredPayments = payments.filter(p => {
                        const contract = contractMap.get(p.contract_id);
                         if (!contract) return false;
                        const unit = unitMap.get(contract.unit_id);
                        const customer = customerMap.get(contract.customer_id);
                        const searchText = `
                            ${unit ? unit.code : ''}
                            ${customer ? customer.name : ''}
                        `.toLowerCase();
                        return searchText.includes(query);
                    });

                    tableBody.innerHTML = filteredPayments.sort((a,b) => b.date.localeCompare(a.date)).map(p => {
                        const contract = contractMap.get(p.contract_id);
                        const unit = contract ? unitMap.get(contract.unit_id) : null;
                        const customer = contract ? customerMap.get(contract.customer_id) : null;
                        return `
                            <tr>
                                <td>${unit ? unit.code : 'N/A'}</td>
                                <td>${customer ? customer.name : 'N/A'}</td>
                                <td>${egp(p.amount)}</td>
                                <td>${p.date}</td>
                                <td>${p.method}</td>
                                <td class="actions">
                                    <button class="btn warn btn-sm" onclick="handleDeletePayment('${p.id}')">حذف</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                searchInput.addEventListener('input', filterAndRender);
                filterAndRender();
            }

            function handleDeletePayment(paymentId) {
                if (!window.confirm('هل أنت متأكد من حذف هذه الدفعة؟ سيؤثر هذا على حسابات الأقساط والعقود.')) {
                    return;
                }

                const payment = app.state.payments.find(p => p.id === paymentId);
                if (payment && payment.installment_id) {
                    const installment = app.state.installments.find(i => i.id === payment.installment_id);
                    if (installment) {
                        installment.amount += payment.amount;
                        installment.status = "غير مدفوع";
                    }
                }

                app.state.payments = app.state.payments.filter(p => p.id !== paymentId);
                saveState();
                renderCurrentPage();
            }

            window.handleDeletePayment = handleDeletePayment;

            function renderReports(container) {
                container.innerHTML = `
                    <div class="page-header">
                        <h2>التقارير</h2>
                    </div>
                    <div class="card">
                        <h3>اختر تقريراً لعرضه</h3>
                        <div class="form-group">
                            <select id="report-select" class="input">
                                <option value="">-- اختر --</option>
                                <option value="overdue">الأقساط المتأخرة</option>
                                <option value="revenue_by_unit">ملخص إيرادات الوحدات</option>
                                <option value="partner_ownership">ملخص ملكية الشركاء</option>
                            </select>
                        </div>
                    </div>
                    <div id="report-display" class="card hidden"></div>
                `;

                document.getElementById('report-select').addEventListener('change', (e) => {
                    const reportType = e.target.value;
                    const display = document.getElementById('report-display');
                    if (!reportType) {
                        display.classList.add('hidden');
                        return;
                    }

                    display.classList.remove('hidden');
                    switch (reportType) {
                        case 'overdue': renderReport_OverdueInstallments(display); break;
                        case 'revenue_by_unit': renderReport_RevenueByUnit(display); break;
                        case 'partner_ownership': renderReport_PartnerOwnership(display); break;
                    }
                });
            }

            function printReport() {
                const reportContent = document.getElementById('report-display').innerHTML;
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html lang="ar" dir="rtl"><head><title>طباعة تقرير</title>');
                const styles = Array.from(document.styleSheets).map(s => s.href ? `<link rel="stylesheet" href="${s.href}">` : `<style>${Array.from(s.cssRules).map(r => r.cssText).join('')}</style>`).join('');
                printWindow.document.write(styles);
                printWindow.document.write('</head><body><div class="card">');
                printWindow.document.write(reportContent);
                printWindow.document.write('</div></body></html>');
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); }, 500);
            }

            function renderReport_OverdueInstallments(display) {
                const { installments, units, customers, contracts } = app.state;
                const overdue = installments.filter(i => i.status !== 'مدفوع' && new Date(i.due_date) < new Date(today()));

                const unitMap = new Map(units.map(u => [u.id, u]));
                const customerMap = new Map(customers.map(c => [c.id, c]));
                const contractMap = new Map(contracts.map(c => [c.id, c]));

                display.innerHTML = `
                    <div class="d-flex justify-between align-center">
                        <h3>تقرير الأقساط المتأخرة (${overdue.length})</h3>
                        <button class="btn btn-sm" onclick="printReport()">طباعة</button>
                    </div>
                    <table class="table">
                        <thead><tr><th>الوحدة</th><th>العميل</th><th>المبلغ</th><th>تاريخ الاستحقاق</th></tr></thead>
                        <tbody>
                            ${overdue.map(inst => {
                                const contract = contractMap.get(inst.contract_id);
                                const unit = contract ? unitMap.get(contract.unit_id) : null;
                                const customer = contract ? customerMap.get(contract.customer_id) : null;
                                return `<tr>
                                    <td>${unit ? unit.code : 'N/A'}</td>
                                    <td>${customer ? customer.name : 'N/A'}</td>
                                    <td>${egp(inst.amount)}</td>
                                    <td>${inst.due_date}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }

            function renderReport_RevenueByUnit(display) {
                 const { contracts, units, payments } = app.state;
                 const revenueByUnit = units.map(unit => {
                     const unitContracts = contracts.filter(c => c.unit_id === unit.id);
                     const contractIds = new Set(unitContracts.map(c => c.id));
                     const unitPayments = payments.filter(p => contractIds.has(p.contract_id));
                     const total = unitPayments.reduce((sum, p) => sum + p.amount, 0);
                     return { code: unit.code, total };
                 });

                 display.innerHTML = `
                    <div class="d-flex justify-between align-center">
                        <h3>تقرير إيرادات الوحدات</h3>
                        <button class="btn btn-sm" onclick="printReport()">طباعة</button>
                    </div>
                    <table class="table">
                        <thead><tr><th>كود الوحدة</th><th>إجمالي الإيرادات المحصلة</th></tr></thead>
                        <tbody>
                            ${revenueByUnit.map(r => `<tr><td>${r.code}</td><td>${egp(r.total)}</td></tr>`).join('')}
                        </tbody>
                    </table>
                 `;
            }

            function renderReport_PartnerOwnership(display) {
                const { partners, units } = app.state;
                let reportHtml = `
                    <div class="d-flex justify-between align-center">
                        <h3>تقرير ملكية الشركاء</h3>
                        <button class="btn btn-sm" onclick="printReport()">طباعة</button>
                    </div>
                `;

                partners.forEach(partner => {
                    const ownedUnits = units.filter(u => u.partners.some(p => p.partner_id === partner.id));
                    reportHtml += `<div class="card mt-1"><h4>${partner.name}</h4>`;
                    if (ownedUnits.length > 0) {
                        reportHtml += `<ul>`;
                        ownedUnits.forEach(unit => {
                            const ownership = unit.partners.find(p => p.partner_id === partner.id).ownership;
                            reportHtml += `<li><strong>${unit.code}:</strong> ${ownership}%</li>`;
                        });
                        reportHtml += `</ul>`;
                    } else {
                        reportHtml += `<p>لا يملك حصص في أي وحدة.</p>`;
                    }
                    reportHtml += `</div>`;
                });

                display.innerHTML = reportHtml;
            }

            window.printReport = printReport;

            function renderBackup(container) {
                container.innerHTML = `
                     <div class="page-header">
                        <h2>حفظ وتحميل البيانات</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <div class="card">
                            <h3><span style="font-size: 1.5rem;">📥</span> حفظ البيانات في ملف</h3>
                            <p>احفظ نسخة من جميع بياناتك الحالية في ملف JSON. احتفظ بهذا الملف في مكان آمن.</p>
                            <button id="backup-btn" class="btn">تنزيل ملف البيانات</button>
                        </div>
                        <div class="card">
                            <h3><span style="font-size: 1.5rem;">📤</span> تحميل البيانات من ملف</h3>
                            <p class="warn" style="color: var(--danger-color);"><strong>تحذير:</strong> تحميل البيانات من ملف سيستبدل جميع البيانات الحالية بشكل دائم.</p>
                            <div class="form-group">
                                <label for="restore-input">اختر ملف البيانات (.json)</label>
                                <input type="file" id="restore-input" class="input" accept=".json">
                            </div>
                            <button id="restore-btn" class="btn warn" disabled>تحميل البيانات</button>
                        </div>
                    </div>
                `;

                document.getElementById('backup-btn').addEventListener('click', handleBackup);

                const restoreInput = document.getElementById('restore-input');
                const restoreBtn = document.getElementById('restore-btn');

                restoreInput.addEventListener('change', () => {
                    restoreBtn.disabled = restoreInput.files.length === 0;
                });

                restoreBtn.addEventListener('click', handleRestore);
            }

            function handleBackup() {
                try {
                    const jsonString = JSON.stringify(app.state, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const date = new Date().toISOString().slice(0, 10);
                    a.href = url;
                    a.download = `real-estate-backup-${date}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (e) {
                    alert('حدث خطأ أثناء إنشاء ملف النسخ الاحتياطي.');
                    console.error(e);
                }
            }

            function handleRestore() {
                const restoreInput = document.getElementById('restore-input');
                const file = restoreInput.files[0];
                if (!file) {
                    alert('الرجاء اختيار ملف أولاً.');
                    return;
                }

                if (!window.confirm('هل أنت متأكد تماماً؟ سيتم استبدال جميع بياناتك الحالية بالبيانات الموجودة في الملف الذي اخترته. لا يمكن التراجع عن هذا الإجراء.')) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const restoredState = JSON.parse(event.target.result);
                        if (restoredState && Array.isArray(restoredState.units)) {
                            app.state = restoredState;
                            saveState();
                            alert('تمت استعادة البيانات بنجاح! سيتم إعادة تحميل الصفحة.');
                            location.reload();
                        } else {
                            alert('الملف غير صالح أو لا يحتوي على البيانات المتوقعة.');
                        }
                    } catch (e) {
                        alert('حدث خطأ أثناء قراءة الملف. تأكد من أنه ملف JSON صالح.');
                        console.error(e);
                    }
                };
                reader.readAsText(file);
            }


            // --- INITIALIZATION ---

            function init() {
                loadState();
                setupNavigation();
                setupModal();
                navigateTo('dashboard-page');
            }

            // Let's go!
            init();
        });
    </script>

</body>
</html>
